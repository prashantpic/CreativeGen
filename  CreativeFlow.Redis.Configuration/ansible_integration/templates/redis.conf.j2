{#
  Jinja2 template for redis.conf
  Generated by Ansible for CreativeFlow.
  Based on SDS section 4.4.2.

  This template consumes variables defined in Ansible inventory
  (e.g., group_vars, host_vars) to create a tailored configuration
  for each Redis instance.

  Required variables for each instance:
  - port
  - password

  Optional variables:
  - bind_ip
  - loglevel
  - maxmemory_mb
  - aof_enabled
  - role ('slave', 'cluster_node')
  - ... and others as needed.
#}
# CreativeFlow Redis Server Configuration (Generated by Ansible)
# DO NOT EDIT THIS FILE MANUALLY. CHANGES WILL BE OVERWRITTEN.

################################## NETWORK #####################################
bind {{ bind_ip | default(redis_default_bind_ip) }}
port {{ port }}
protected-mode yes
tcp-keepalive 300

################################## SECURITY ####################################
requirepass "{{ password }}"

################################### GENERAL ####################################
daemonize yes
pidfile /var/run/redis_{{ port }}.pid
loglevel {{ loglevel | default(redis_default_loglevel) }}
logfile "{{ redis_log_dir }}/redis_{{ port }}.log"
databases 16

################################ SNAPSHOTTING ################################
save 900 1
save 300 10
save 60 10000
stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename dump_{{ port }}.rdb
dir {{ redis_data_dir_base }}/{{ port }}

############################## APPEND ONLY MODE ##############################
{% if aof_enabled | default(redis_default_aof_enabled) == "yes" %}
appendonly yes
appendfilename "appendonly_{{ port }}.aof"
{% else %}
appendonly no
{% endif %}
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

############################# MEMORY MANAGEMENT ################################
{% if maxmemory_mb is defined and maxmemory_mb %}
maxmemory {{ maxmemory_mb }}mb
{% endif %}
maxmemory-policy allkeys-lru

########################### KEYSPACE NOTIFICATIONS ###########################
notify-keyspace-events KEA

################################ LUA SCRIPTING ###############################
lua-time-limit 5000

########################### REPLICATION (for slaves) ###########################
{% if role is defined and role == "slave" %}
replicaof {{ master_ip }} {{ master_port }}
{% if master_password is defined and master_password %}
masterauth "{{ master_password }}"
{% endif %}
replica-serve-stale-data yes
{% endif %}

############################# CLUSTER #############################
{% if cluster_enabled is defined and cluster_enabled == "yes" %}
cluster-enabled yes
cluster-config-file nodes-{{ port }}.conf
cluster-node-timeout {{ cluster_node_timeout | default(15000) }}
{% if announce_ip is defined %}
cluster-announce-ip {{ announce_ip }}
cluster-announce-port {{ port }}
cluster-announce-bus-port {{ cluster_bus_port | default(port + 10000) }}
{% endif %}
{% endif %}