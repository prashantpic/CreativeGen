# Configuration: MinIO Integration

This document specifies how the `CreativeFlow.N8NWorkflowEngine` interacts with MinIO for S3-compatible object storage. MinIO is the primary repository for all user-uploaded and AI-generated assets.

## Connection Parameters

The n8n instance requires credentials to access MinIO. These should be configured as environment variables or through the n8n credential store.

*   **`MINIO_ENDPOINT`**: The URL for the MinIO server (without `http://` or `https://`).
    *   Example: `minio.creativeflow.svc.cluster.local:9000`
*   **`MINIO_ACCESS_KEY`**: The MinIO access key (username).
*   **`MINIO_SECRET_KEY`**: The MinIO secret key (password).
*   **`MINIO_USE_SSL`**: Set to `true` if the connection to MinIO should use HTTPS.

Within the n8n UI, these parameters will be used to create a "MinIO Credentials" entry, which will be referenced by the MinIO nodes in workflows.

## Bucket and Path Conventions

All assets are stored in a primary bucket. Workflows must construct object paths dynamically based on job context to ensure proper organization and prevent collisions. This aligns with the requirements in SRS 7.4.1.

*   **Default Bucket**: `creativeflow-assets`
    *   All MinIO nodes in n8n workflows should be configured to use this bucket by default.

### Path Structures

The `fileName` property of the n8n MinIO node should be set using expressions.

*   **Generated Assets (Final)**
    *   **Purpose**: To store the final, high-resolution asset chosen or generated by the user.
    *   **Path Format**: `/generated_assets/{projectId}/{generationId}/final/{filename}`
    *   **n8n Expression Example**: `={{ 'generated_assets/' + $items('Set Workflow Context')[0].json.workflowContext.projectId + '/' + $items('Set Workflow Context')[0].json.workflowContext.jobId + '/final/output.png' }}`

*   **Generated Assets (Samples)**
    *   **Purpose**: To store the initial batch of sample images generated for user selection.
    *   **Path Format**: `/generated_assets/{projectId}/{generationId}/samples/{sampleIndex}_{filename}`
    *   **Note**: If samples are handled by n8n, a loop would generate multiple files with incrementing indices.

*   **User Uploads**
    *   **Purpose**: To store assets uploaded by users (e.g., as input for image-to-image tasks).
    *   **Path Format**: `/user_uploads/{userId}/{timestamp}_{filename}`
    *   **Note**: This is typically handled by the `AI Generation Orchestration Service` before the job is sent to n8n. n8n workflows will receive a path to an already uploaded asset.

*   **Brand Kit Assets**
    *   **Purpose**: To store brand kit logos and other assets.
    *   **Path Format**: `/brand_kits/{brandKitId}/{assetType}/{filename}`
    *   **Note**: This is handled outside the generation workflows.

## Usage in Workflows

*   The `CreativeGeneration_Main.workflow.json` uses a **MinIO node** with the `Upload` operation to store the final generated asset after it has passed content moderation.
*   The node is configured to use binary data mode (`"binaryData": true`) as it receives the image data directly from the preceding AI generation step.
*   The output of the MinIO node provides the final `url` and `path` of the stored asset, which are then used in the notification payload.